---
output: github_document
references:
  - id: hurricane
    title: "Female hurricanes are deadlier than male hurricanes"
    type: article-journal
    issued:
      year: 2014
      month: 6
      day: 17
    URL: https://doi.org/10.1073/pnas.1402786111
    DOI: 10.1073/pnas.1402786111
    journal: Proceeedings fo the National Academiy of Sciences of the United States of America
    volume: 111
    issue: 24
    page: 8782-8787
    author:
    - given: Kiju
      family: Jung
    - given: Sharon
      family: Shavitt
    - given: Madhu
      family: Viswanathan
    - given: "Joseph M."
      family: Hilbe
  - id: multiverseR
    title: "multiverse: Multiplexing Alternative Data Analyses in R Notebooks (Version 0.5.0)"
    type: article-journal
    URL: https://github.com/MUCollective/multiverse
    issued:
      year: 2021
    journal: OSF Preprints
    author:
    - given: Abhraneel
      family: Sarma
    - given: Alex
      family: Kale
    - given: Michael
      family: Moon
    - given: Nathan
      family: Taback
    - given: Fanny
      family: Chevalier
    - given: Jessica
      family: Hullman
    - given: Matthew
      family: Kay
  - id: multiverse
    title: "Increasing transparency through a multiverse analysis"
    type: article-journal
    issued:
      year: 2016
      month: 9
      day: 29
    URL: https://doi.org/10.1177/1745691616658637
    DOI: 10.1177/1745691616658637
    journal: Perspectives on Psychological Science
    volume: 11
    issue: 5
    page: 702-712
    author:
    - given: Sara
      family: Steegen
    - given: Francis
      family: Tuerlinckx
    - given: Andrew
      family: Gelman
    - given: Wolf
      family: Vanpaemel
  - id: speccurve
    title: "Specification curve analsysis"
    type: article-journal
    issued:
      year: 2020
      month: 7
      day: 27
    URL: https://doi.org/10.1038/s41562-020-0912-z 
    DOI: 10.1038/s41562-020-0912-z 
    journal: Nature Human Behaviour
    volume: 4
    page: 1208-1214
    author:
      - given: Uri
        family: Simonsohn
      - given: "Joseph P."
        family: Simmons
      - given: "Leif D."
        family: Nelson
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  echo = FALSE
)
```

# mverse

<!-- badges: start -->
<!-- badges: end -->

_mverse_ is an extension to multiverse package [@multiverseR]
which allows users create explorable multiverse analysis [@multiverse]
in R. This extension provides user friendly abstraction
and a set of examples for researchers, educators,
and students in statistics.

## Installation

<!-- You can install the released version of mverse from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("mverse") -->
<!-- ``` -->

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("mverseanalysis/mverse")
```

## Example: Hurricane Names and Gender-based Expectations

This is an example which demonstrating a full analysis using `mverse` using the `hurricane` dataset included in the package. The data set comes from a study by @hurricane and contains the following information about hurricanes that landed on the U.S. between 1950 and 2021:

+   Femininity rating on hurricane names (1:very masculine; 11: very feminine)
+   Total fatality counts
+   Total damage dollar amount normalized to 2013 USD
+   Maximum wind speed
+   Minimum pressure
+   Year

Below are the first few lines of the dataset. See `?hurricane` for details on the dataset.

```{r example, message=FALSE}
library(mverse)
library(tidyverse)
library(ggplot2)
library(patchwork)
hurricane <- hurricane %>%
  mutate(
    nameyear = paste(Name, Year, sep = ", ") # serves as a unique identifier
  ) %>%
  select(Name, Year, alldeaths, MasFem, Minpressure_Updated_2014, HighestWindSpeed, NDAM,
         Category, MinPressure_before, Elapsed.Yrs, Source, nameyear)
head(hurricane %>% select(-nameyear))
```

```{r fig.asp=9/16, dpi=144}
topdeaths <- hurricane %>%
  mutate(nameyear = factor(nameyear, levels = nameyear[order(alldeaths)])) %>%
  arrange(-alldeaths) %>%
  slice(1:10) 
topdamages <- hurricane %>%
  mutate(nameyear = factor(nameyear, levels = nameyear[order(NDAM)])) %>%
  arrange(-NDAM) %>%
  slice(1:10)
p1 <- topdeaths %>%
  ggplot(aes(x = nameyear, y = alldeaths, fill = MasFem > 6)) +
  theme_void() +
  geom_bar(stat = "identity", show.legend = FALSE) +
  labs(title = "10 deadliest Atlantic hurricanes",  
       subtitle = "in the U.S between 1950 and 2012.") +
  scale_y_continuous(labels = scales::comma, name = "Fatalities", position = "right") +
  scale_fill_manual(values = c(8, 1)) +
  coord_flip() +
  geom_text(aes(label = Name), color = "white", size = 4, hjust = 1, nudge_y = -25,
            data = topdeaths %>% filter(MasFem > 6, alldeaths > 350)) +
  geom_text(aes(label = Name), color = "black", size = 4, hjust = 0, nudge_y = 25,
            data = topdeaths %>% filter(MasFem > 6, alldeaths <= 350)) +
  geom_text(aes(label = Name), color = 8, size = 4, hjust = 0, nudge_y = 25,
            data = topdeaths %>% filter(MasFem <= 6)) +
  theme(
    plot.title = element_text(size = 12),
    plot.subtitle = element_text(size = 12),
    axis.text.x.top = element_text(size = 10),
    axis.title.x.top = element_text(size = 10, hjust = 1),
    plot.margin = margin(l= 10, r = 10)
  )
p2 <- topdamages %>%
  ggplot(aes(x = nameyear, y = NDAM, fill = MasFem > 6)) +
  theme_void() +
  geom_bar(stat = "identity", show.legend = FALSE) +
  labs(title = "10 mosting damaging Atlantic hurricanes",
       subtitle = "in the U.S between 1950 and 2012.",
       caption = "1. Financial damage amount in USD normlized to 2013 values.") +
  scale_y_continuous(labels = scales::comma, position = "right",
                     name = expression(Damage^1)) +
  scale_fill_manual(values = c(8, 1)) +
  coord_flip() +
  geom_text(aes(label = Name), color = "white", size = 4, hjust = 1, nudge_y = -1000,
            data = topdamages %>% filter(MasFem > 6)) +
  geom_text(aes(label = Name), color = "black", size = 4, hjust = 1, nudge_y = -1000,
            data = topdamages %>% filter(MasFem <= 6)) +
  theme(
    plot.title = element_text(size = 12),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 8),
    axis.text.x.top = element_text(size = 10),
    axis.title.x.top = element_text(size = 10, hjust = 1),
    plot.margin = margin(l= 10, r = 10)
  )
p1 + p2
```

Inspecting the data reveals that 8 of the top 10 hurricanes that caused most fatalities had female names while only 6 of the top 10 hurricanes with the most financial damage had female names. @hurricane hypothesized that this gap was due to people underestimating the severity of a hurricane when it's named with a female name. Jung used the data to investigate whether hurricanes with _feminine_ names led to _more fatalities given equal strength_ because their names didn't motivate as much preparedness as hurricanes with _masculine_ names.

To illustrate a multiverse analysis using `mverse`, we will consider a Poisson regression model that models the relationship between the femininity of a hurricane's name and the total fatalities it caused, while controlling for the strength of the hurricane. We will expand the multiverse based on the following two decision points:

1.  Are there any outliers that we should remove from analysis? If so, which ones should we exclude?
2.  Which variable best captures the strength of a hurricane?

In `mverse`, such decision points are called _branches_ and the individual paths we can take at each branch are called _options_.


### Branches for Outliers

```{r eval=FALSE, fig.asp=1, dpi=144}
p1 <- hurricane %>%
  ggplot(aes(x = deaths, fill = name %in% (hurricane %>% arrange(-deaths) %>% slice(1:2) %>% pull(name))))+
  theme_void() +
  geom_dotplot(binwidth = 25, color = "white",
               dotsize = 1, stackratio = 1,
               show.legend = FALSE) +
  geom_text(aes(label = nameyear, y = 0.05), hjust = 0,
                color = 2, show.legend = FALSE,
                data = hurricane %>% arrange(-deaths) %>% slice(1:2)) +
  scale_fill_manual(values = c(8, 2, 2)) +
  labs(title = "Distribution of fatalities.", x = "Fatalities") +
  theme(
      plot.title = element_text(colour = "black", size = 12),
      plot.subtitle = element_text(colour = "black", size = 12),
      axis.text.y = element_text(size = 10, hjust = 1),
      axis.title.y = element_text(size = 10, hjust = 1, angle = 90),
      plot.margin = unit(rep(12, 4), "points")
  ) + 
  coord_flip()
p2 <- hurricane %>%
  ggplot(aes(x = damage, fill = name %in% (hurricane %>% arrange(-damage) %>% slice(1:2) %>% pull(name)))) +
  theme_void() +
  geom_dotplot(binwidth = 2500, color = "white", 
               dotsize = 1, stackratio = 1,
               show.legend = FALSE) +
  geom_text(aes(label = nameyear, y = 0.06), hjust = 0,
                color = 2, show.legend = FALSE,
                data = hurricane %>% arrange(-damage) %>% slice(1:2)) +
  scale_fill_manual(values = c(8, 2)) +
  labs(title = "Distribution of damage amounts.", x = "Damage (2013 USD)") +
  theme(
      plot.title = element_text(colour = "black", size = 12),
      plot.subtitle = element_text(colour = "black", size = 12),
      axis.text.y = element_text(size = 10, hjust = 1),
      axis.title.y = element_text(size = 10, hjust = 1, angle = 90),
      plot.margin = unit(rep(12, 4), "points")
  ) +
  coord_flip()
p3 <- hurricane %>%
  ggplot(aes(x = max_wind_speed, fill = name %in% (hurricane %>% arrange(-max_wind_speed) %>% slice(1:2) %>% pull(name)))) +
  theme_void() +
  geom_dotplot(binwidth = 5, color = "white", dotsize = 1, stackratio = 1,
               show.legend = FALSE) +
  geom_text(aes(label = nameyear, y = 0.05),
                color = 2, show.legend = FALSE, hjust = 0,
                data = hurricane %>% arrange(-max_wind_speed) %>% slice(1:2)) +
  scale_fill_manual(values = c(8, 2)) +
  labs(title = "Distribution of the maximum wind speeds.", x = "Maximum Wind Speed") +
  theme(
    plot.title = element_text(colour = "black", size = 12),
    plot.subtitle = element_text(colour = "black", size = 12),
    axis.text.y = element_text(size = 10, hjust = 1),
    axis.title.y = element_text(size = 10, hjust = 1, angle = 90),
    plot.margin = unit(rep(12, 4), "points")
  ) +
  coord_flip()
p4 <- hurricane %>%
  ggplot(aes(x = min_pressure, fill = nameyear %in% (hurricane %>% arrange(min_pressure) %>% slice(1:2) %>% pull(nameyear)))) +
  theme_void() +
  geom_dotplot(binwidth = 5, color = "white", dotsize = 1, stackratio = 1,
               show.legend = FALSE) +
  geom_text(aes(label = nameyear, y = 0.05),
                color = 2, show.legend = FALSE, hjust = 0,
                data = hurricane %>% arrange(min_pressure) %>% slice(1:2)) +
  scale_fill_manual(values = c(8, 2)) +
  labs(title = "Distribution of the minimum pressures.", x = "Minimum Pressure") +
  theme(
    plot.title = element_text(colour = "black", size = 12),
    plot.subtitle = element_text(colour = "black", size = 12),
    axis.text.y = element_text(size = 10, hjust = 1),
    axis.title.y = element_text(size = 10, hjust = 1, angle = 90),
    plot.margin = unit(rep(12, 4), "points")
  ) +
  coord_flip()
p1 + p2 + p3 + p4
```


Upon inspecting the distributions of the fatalities, financial damage amounts, maximum wind speeds, and minimum pressures, we may choose to exclude

+   Katrina, 2005 only;
+   Katrina, 2005 and Audrey, 1957;
+   none.

We can use `filter_branch` to declare the four options, or branches, of defining the outliers.

```{r}
hurricane_outliers <- filter_branch(
  ! nameyear %in% c("Katrina, 2005"),
  ! nameyear %in% c("Katrina, 2005", "Audrey, 1957"),
  ! nameyear %in% c("Katrina, 2005", "Audrey, 1957", "Andrew, 1992"),
  TRUE # include ALL
)
```

### Mutate Branch: Branches for Defining a Variable

To control for the strength of a hurricane, we may use one of

+   Total damage dollar amount normalized to 2013 USD;
+   Maximum wind speed; and
+   Minimum pressure

from the data set. We can define a new variable `hurricane_strength` using `mutate_branch` such that we create a multiverse that investigates all three options.

```{r}
hurricane_strength <- mutate_branch(
  damage, max_wind_speed, min_pressure
)
```

### GLM mverse: Fit a GLM Model

To fit a Poisson regression model, we can use `glm_mverse` in the `mverse` library. `glm_mverse` runs `glm` method across the multiverse. `glm_mverse` needs to pass the model specification using a formula and the likelihood family to `glm` in each universe. We can specify the formula and the family using `formula_branch` and `family_branch`. 

```{r}
model <- formula_branch(deaths ~ hurricane_strength * femininity)
distribution <- family_branch(poisson)
```

Once we have all branches defined, we can add them to the `mverse` object using `add_***_branch` methods and fit the model with `glm_mverse`.

```{r eval=FALSE}
mv <- mv %>%
  add_filter_branch(hurricane_outliers) %>%
  add_mutate_branch(hurricane_strength) %>%
  add_formula_branch(model) %>%
  add_family_branch(distribution) %>%
  glm_mverse() 
```


### Summary and Specification Curve: Inspect Results

After completing the analysis, we can extract the results using `summary` method. The method returns a `tibble` with branching options, estimates, 95\% confidence intervals for all regression terms across the multiverse. Below, we focus on the main effect on _femininity_.

```{r message=FALSE, eval=FALSE}
summary(mv) %>%
  filter(term == "femininity") %>% # inspect the main effect on femininity
  select(hurricane_outliers_branch, hurricane_strength_branch, 
         estimate, p.value, conf.low, conf.high) %>%
  knitr::kable() # for display
```


We can also inspect the result graphically using `spec_curve` method. The method builds a specification curve analysis [@speccurve] for the specified term. By default, the universes are sorted by the estimate of interest specified by `var="femininity"`.

```{r eval=FALSE, dpi=144}
spec_curve(mv, var = "femininity")
```

The method also allows sorting the universes by whether p-value < 0.05 or by branch options.

```{r eval=FALSE, dpi=144}
spec_curve(mv, var = "femininity", branch_order = hurricane_outliers_branch)
spec_curve(mv, var = "femininity", color_order = TRUE)
```

## References
