---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# mverse

<!-- badges: start -->
<!-- badges: end -->

_mverse_ is an extension to multiverse package [^1]
which allows users create explorable multiverse analysis [^2]
in R. This extension provides user friendly abstraction
and a set of examples for researchers, educators,
and students in statistics.

## Installation

<!-- You can install the released version of mverse from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("mverse") -->
<!-- ``` -->

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("mverseanalysis/mverse")
```

## Example: Hurricane Names and Gender-based Expectations

This is an example which demonstrating a full analysis using `mverse` using the `hurricane` data set included in the package. The data set comes from a study by Jung et al. [^3] and contains the following information about hurricanes that landed on the U.S. between 1950 and 2021:

+   Femininity rating on hurricane names (1:very masculine; 11: very feminine)
+   Total fatality counts
+   Total damage dollar amount normalized to 2013 USD
+   Maximum wind speed
+   Minimum pressure
+   Year

```{r example, message=FALSE}
library(mverse)
library(tidyverse)
library(ggplot2)
library(patchwork)
hurricane <- hurricane %>%
  mutate(
    nameyear = paste(Name, Year, sep = ", ") # serves as a unique identifier
  ) %>%
  rename(
    name = Name, # name of the hurricane
    deaths = alldeaths, # total fatality counts
    femininity = MasFem, # femininity rating on hurricane names (1: very masculine; 11: very feminine)
    year = Year, # year the hurricane landed on the U.S.
    min_pressure = Minpressure_Updated_2014, # minimum pressure
    max_wind_speed = HighestWindSpeed, # maximum wind speed
    damage = NDAM, # total damage dollar amount normalized to 2013 USD
  ) %>%
  select(
    name, nameyear, deaths, femininity, year,
    min_pressure, max_wind_speed, damage
  )
head(hurricane)
```

```{r echo=FALSE, out.width="100%", fig.asp=9/16, dpi=144}
topdeaths <- hurricane %>%
  mutate(nameyear = factor(nameyear, levels = nameyear[order(deaths)])) %>%
  arrange(-deaths) %>%
  slice(1:10) 
topdamages <- hurricane %>%
  mutate(nameyear = factor(nameyear, levels = nameyear[order(damage)])) %>%
  arrange(-damage) %>%
  slice(1:10)
p1 <- topdeaths %>%
  ggplot(aes(x = nameyear, y = deaths, fill = femininity > 6)) +
  theme_void() +
  geom_bar(stat = "identity", show.legend = FALSE) +
  labs(title = "10 deadliest Atlantic hurricanes",  
       subtitle = "in the U.S between 1950 and 2012.") +
  scale_y_continuous(labels = scales::comma, name = "Fatalities", position = "right") +
  scale_fill_manual(values = c(8, 1)) +
  coord_flip() +
  geom_text(aes(label = name), color = "white", size = 4, hjust = 1, nudge_y = -25,
            data = topdeaths %>% filter(femininity > 6, deaths > 350)) +
  geom_text(aes(label = name), color = "black", size = 4, hjust = 0, nudge_y = 25,
            data = topdeaths %>% filter(femininity > 6, deaths <= 350)) +
  geom_text(aes(label = name), color = 8, size = 4, hjust = 0, nudge_y = 25,
            data = topdeaths %>% filter(femininity <= 6)) +
  theme(
    plot.title = element_text(size = 12),
    plot.subtitle = element_text(size = 12),
    axis.text.x.top = element_text(size = 10),
    axis.title.x.top = element_text(size = 10, hjust = 1),
    plot.margin = margin(l= 10, r = 10)
  )
p2 <- topdamages %>%
  ggplot(aes(x = nameyear, y = damage, fill = femininity > 6)) +
  theme_void() +
  geom_bar(stat = "identity", show.legend = FALSE) +
  labs(title = "10 mosting damaging Atlantic hurricanes",
       subtitle = "in the U.S between 1950 and 2012.",
       caption = "1. Financial damage amount in USD normlized to 2013 values.") +
  scale_y_continuous(labels = scales::comma, position = "right",
                     name = expression(Damage^1)) +
  scale_fill_manual(values = c(8, 1)) +
  coord_flip() +
  geom_text(aes(label = name), color = "white", size = 4, hjust = 1, nudge_y = -1000,
            data = topdamages %>% filter(femininity > 6)) +
  geom_text(aes(label = name), color = "black", size = 4, hjust = 1, nudge_y = -1000,
            data = topdamages %>% filter(femininity <= 6)) +
  theme(
    plot.title = element_text(size = 12),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 8),
    axis.text.x.top = element_text(size = 10),
    axis.title.x.top = element_text(size = 10, hjust = 1),
    plot.margin = margin(l= 10, r = 10)
  )
p1 + p2
```

Inspecting the data reveals that 8 of the top 10 hurricanes that caused most fatalities had female names while only 6 of the top 10 hurricanes with the most financial damage had female names. Jung [^3] hypothesized that this gap was due to people underestimating the severity of a hurricane when it's named with a female name. Jung used the data to investigate whether hurricanes with _feminine_ names led to _more fatalities given equal strength_ because their names didn't motivate as much preparedness as hurricanes with _masculine_ names.

To demonstrate a multiverse analysis using `mverse`, we will consider a Poisson regression model that models the relationship between the femininity of a hurricane's name and the total fatalities it caused, while controlling for the strength of the hurricane. We will expand the multiverse based on the following two decision points:

1.  Are there any outliers that we should remove from analysis? If so, which ones should we exclude?
2.  Which variable best captures the strength of a hurricane?


### Initiate

We first initiate the multivere analysis by creating a `mverse` object with the data set. Note that the library assumes a single data set.

```{r}
mv <- create_multiverse(hurricane)
# mv <- mverse(hurricane) # alternative method; `mverse` is an alias of `create_multiverse`.
```


### Filter Branch: Branches for Outliers

```{r echo=FALSE, out.width="100%", fig.asp=1, dpi=144}
p1 <- hurricane %>%
  ggplot(aes(x = deaths, fill = name %in% (hurricane %>% arrange(-deaths) %>% slice(1:2) %>% pull(name))))+
  theme_void() +
  geom_dotplot(binwidth = 25, color = "white",
               dotsize = 1, stackratio = 1,
               show.legend = FALSE) +
  geom_text(aes(label = nameyear, y = 0.05), hjust = 0,
                color = 2, show.legend = FALSE,
                data = hurricane %>% arrange(-deaths) %>% slice(1:2)) +
  scale_fill_manual(values = c(8, 2, 2)) +
  labs(title = "Distribution of fatalities.", x = "Fatalities") +
  theme(
      plot.title = element_text(colour = "black", size = 12),
      plot.subtitle = element_text(colour = "black", size = 12),
      axis.text.y = element_text(size = 10, hjust = 1),
      axis.title.y = element_text(size = 10, hjust = 1, angle = 90),
      plot.margin = unit(rep(12, 4), "points")
  ) + 
  coord_flip()
p2 <- hurricane %>%
  ggplot(aes(x = damage, fill = name %in% (hurricane %>% arrange(-damage) %>% slice(1:2) %>% pull(name)))) +
  theme_void() +
  geom_dotplot(binwidth = 2500, color = "white", 
               dotsize = 1, stackratio = 1,
               show.legend = FALSE) +
  geom_text(aes(label = nameyear, y = 0.06), hjust = 0,
                color = 2, show.legend = FALSE,
                data = hurricane %>% arrange(-damage) %>% slice(1:2)) +
  scale_fill_manual(values = c(8, 2)) +
  labs(title = "Distribution of damage amounts.", x = "Damage (2013 USD)") +
  theme(
      plot.title = element_text(colour = "black", size = 12),
      plot.subtitle = element_text(colour = "black", size = 12),
      axis.text.y = element_text(size = 10, hjust = 1),
      axis.title.y = element_text(size = 10, hjust = 1, angle = 90),
      plot.margin = unit(rep(12, 4), "points")
  ) +
  coord_flip()
p3 <- hurricane %>%
  ggplot(aes(x = max_wind_speed, fill = name %in% (hurricane %>% arrange(-max_wind_speed) %>% slice(1:2) %>% pull(name)))) +
  theme_void() +
  geom_dotplot(binwidth = 5, color = "white", dotsize = 1, stackratio = 1,
               show.legend = FALSE) +
  geom_text(aes(label = nameyear, y = 0.05),
                color = 2, show.legend = FALSE, hjust = 0,
                data = hurricane %>% arrange(-max_wind_speed) %>% slice(1:2)) +
  scale_fill_manual(values = c(8, 2)) +
  labs(title = "Distribution of the maximum wind speeds.", x = "Maximum Wind Speed") +
  theme(
    plot.title = element_text(colour = "black", size = 12),
    plot.subtitle = element_text(colour = "black", size = 12),
    axis.text.y = element_text(size = 10, hjust = 1),
    axis.title.y = element_text(size = 10, hjust = 1, angle = 90),
    plot.margin = unit(rep(12, 4), "points")
  ) +
  coord_flip()
p4 <- hurricane %>%
  ggplot(aes(x = min_pressure, fill = nameyear %in% (hurricane %>% arrange(min_pressure) %>% slice(1:2) %>% pull(nameyear)))) +
  theme_void() +
  geom_dotplot(binwidth = 5, color = "white", dotsize = 1, stackratio = 1,
               show.legend = FALSE) +
  geom_text(aes(label = nameyear, y = 0.05),
                color = 2, show.legend = FALSE, hjust = 0,
                data = hurricane %>% arrange(min_pressure) %>% slice(1:2)) +
  scale_fill_manual(values = c(8, 2)) +
  labs(title = "Distribution of the minimum pressures.", x = "Minimum Pressure") +
  theme(
    plot.title = element_text(colour = "black", size = 12),
    plot.subtitle = element_text(colour = "black", size = 12),
    axis.text.y = element_text(size = 10, hjust = 1),
    axis.title.y = element_text(size = 10, hjust = 1, angle = 90),
    plot.margin = unit(rep(12, 4), "points")
  ) +
  coord_flip()
p1 + p2 + p3 + p4
```


Upon inspecting the distributions of the fatalities, financial damage amounts, maximum wind speeds, and minimum pressures, we may choose to exclude

+   Katrina, 2005 only;
+   Katrina, 2005 and Audrey, 1957;
+   Katrina, 2005, Audrey, 1957, and Andrew, 1992; or
+   none.

We can use `filter_branch` to declare the four options, or branches, of defining the outliers.

```{r}
hurricane_outliers <- filter_branch(
  ! nameyear %in% c("Katrina, 2005"),
  ! nameyear %in% c("Katrina, 2005", "Audrey, 1957"),
  ! nameyear %in% c("Katrina, 2005", "Audrey, 1957", "Andrew, 1992"),
  TRUE # include ALL
)
```

### Mutate Branch: Branches for Defining a Variable

To control for the strength of a hurricane, we may use one of

+   Total damage dollar amount normalized to 2013 USD;
+   Maximum wind speed; and
+   Minimum pressure

from the data set. We can define a new variable `hurricane_strength` using `mutate_branch` such that we create a multiverse that investigates all three options.

```{r}
hurricane_strength <- mutate_branch(
  damage, max_wind_speed, min_pressure
)
```

### GLM mverse: Fit a GLM Model

To fit a Poisson regression model, we can use `glm_mverse` in the `mverse` library. `glm_mverse` runs `glm` method across the multiverse. `glm_mverse` needs to pass the model specification using a formula and the likelihood family to `glm` in each universe. We can specify the formula and the family using `formula_branch` and `family_branch`. 

```{r}
model <- formula_branch(deaths ~ hurricane_strength * femininity)
distribution <- family_branch(poisson)
```

Once we have all branches defined, we can add them to the `mverse` object using `add_***_branch` methods and fit the model with `glm_mverse`.

```{r}
mv <- mv %>%
  add_filter_branch(hurricane_outliers) %>%
  add_mutate_branch(hurricane_strength) %>%
  add_formula_branch(model) %>%
  add_family_branch(distribution) %>%
  glm_mverse() 
```


### Summary and Specification Curve: Inspect Results

After completing the analysis, we can extract the results using `summary` method. The method returns a `tibble` with branching options, estimates, 95\% confidence intervals for all regression terms across the multiverse. Below, we focus on the main effect on _femininity_.

```{r message=FALSE}
summary(mv) %>%
  filter(term == "femininity") %>% # inspect the main effect on femininity
  select(hurricane_outliers_branch, hurricane_strength_branch, 
         estimate, p.value, conf.low, conf.high) %>%
  knitr::kable() # for display
```


We can also inspect the result graphically using `spec_curve` method. The method builds a specification curve analysis [^4] for the specified term.

```{r}
# TODO: spec_curve
```

## References

[^1]: Sarma, A. and Kay, M. _Multiverse: An R package for creating multiverse analysis._ 2020. https://mucollective.github.io/multiverse/

[^2]: Steegen S, Tuerlinckx F, Gelman A, Vanpaemel W. _Increasing Transparency Through a Multiverse Analysis._ Perspect Psychol Sci. 2016;11(5):702‚Äê712. doi:10.1177/1745691616658637 URL: https://pubmed.ncbi.nlm.nih.gov/27694465/

[^3]: Jung, K., Shavitt, S., Viswanathan, M., and Hilbe, J.M. (2014) _Female hurricanes are deadlier than male hurricanes._  
Proceedings of the National Academy of Sciences, 111(24), 8782-8787, https://doi.org/10.1073/pnas.1402786111

[^4]: Simonsohn, U., Simmons, J.P, and Nelson, L.D. (2020) _Specification curve analysis._ Nature Human Behaviour, 4, 1208-1214, https://doi.org/10.1038/s41562-020-0912-z 
