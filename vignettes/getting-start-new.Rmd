---
title: "Getting started with mverse"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started with mverse}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
references:
  - id: original
    title: "Female hurricanes are deadlier than male hurricanes"
    type: article-journal
    issued:
      year: 2014
      month: 6
      day: 17
    URL: https://doi.org/10.1073/pnas.1402786111
    DOI: 10.1073/pnas.1402786111
    journal: Proceeedings fo the National Academiy of Sciences of the United States of America
    volume: 111
    issue: 24
    page: 8782-8787
    author:
    - given: Kiju
      family: Jung
    - given: Sharon
      family: Shavitt
    - given: Madhu
      family: Viswanathan
    - given: "Joseph M."
      family: Hilbe
  - id: multiverse
    title: "multiverse: R package for creating explorable multiverse analysis"
    type: entry
    URL: https://mucollective.github.io/multiverse/
    accessed:
      year: 2020
    author:
    - given: Abhraneel
      family: Sarma
    - given: Matthew
      family: Kay
  - id: boba
    title: "Boba: Authoring and Visualizing Multiverse Analyses"
    type: entry
    URL: https://arxiv.org/abs/2007.05551
    issued:
      year: 2020
      month: 7
      day: 30
    accessed:
      year: 2020
    author:
    - given: Yang
      family: Liu
    - given: Alex
      family: Kale
    - given: Tim
      family: Althoff
    - given: Jeffrey
      family: Heer
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
)
```

This vignette aims to introduce the workflow of a multiverse analysis with `mverse` and the syntax for commonly used functions. 

The typical workflow of multiverse analysis with `mverse` is
1. Initialize a `multiverse` object with the dataset.
2. Define all the decisions as *branches*.
3. Add defined *branches* into the `multiverse` object.
4. Run models, hypothesis tests, and plots. 

# Loading packages
```{r load_package, warning=FALSE, message=FALSE}
library(mverse)
```

# Create the `multiverse` on the dataset
To start a multiverse analysis, we first create a `mverse` object with the data.
As an example, we will use the `hurricane` dataset [@original]. 
The dataset is stored as a data frame, with 94 observations and 12 variables.

```{r load_data, warning=FALSE, message=FALSE}
knitr::kable(head(hurricane))
```
```{r create_object}
mv <- create_multiverse(hurricane)
```
# Define Branches
Each branch defines a "decision point". The multiverse then branches out to different "universe", or analysis paths. In `mverse` package, we define branches using `X_branch(...)`, where `...` are expressions that defines reasonable decision choices at that "decision point". 

## Branches for Data munipulation
`filter_branch` takes some logical predicates, and finds the observations where the condition is true. 

One of the commonest usages of `filter_branch` is to exclude outliers, In this example, we use `filter_branch` to exclude the most extreme hurricanes. 

```{r filter_branch}

# Exclude up to 2 most extreme observations in term of death
death_outliers <- filter_branch(
  TRUE, # keep all observations
  Name != 'Katrina', # excludes the most deadly observation
  !(Name %in% c('Katrina', 'Audrey')) # excludes the two most deadly observations
)
```

`mutate_branch` takes expressions that modify data columns. 

`mutate_branch` can be used to provide different definitions for a variable. 
Also, `mutate_branch` can be used to create different transformations on data columns. 

```{r mutate_branch}
# Define femininity 
femininity <- mutate_branch(
  Gender_MF, # based on binary gender
  MasFem # based on the scale
)

# Define damage
damage <- mutate_branch(
  NDAM, # No transform
  log(NDAM) # log transform
)
```



## Branches for Modelling and Hypothesis Tests 

`formula_branch` takes `formula` objects, and `family_branch` takes `family` objects. These two branches will be used in modelings and/or hypothesis tests. 

As an example, we will add formulas and families for fitting generalized linear models. 
``` {r modelling_branch}
# Define the formulas 
formulas <- formula_branch(
  alldeaths ~ MasFem + damage + HighestWindSpeed, # simplest additive model
  alldeaths ~ MasFem * damage + HighestWindSpeed, # interactions between femininity and damage
)


families <- family_branch(
  gaussian(),
  poisson()
)
```

# Add branches to the multiverse
After defining all branches, we need to add the branches to the multiverse by using `add_X_branch`. After adding all branches, we can check the branch definitions using `summary`.

```{r add_branches}
mv %>%
  add_filter_branch(death_outliers) %>% 
  add_mutate_branch(femininity, damage) %>% 
  add_formula_branch(formulas) %>%
  add_family_branch(families)
summary(mv)

```

# Executing the analysis
After adding all branches, we can then fits different models or run hypothesis tests by calling `X_mverse` on the multiverse object. The results will be stored in the `multiverse` object.

As an example, we will run `glm`. For more details on other modelling methods, check the vignette on regression and hypothesis tests. 

```{r fit_model}
glm_mverse(mv) # Note that this won't give the output, the models are stored in mv
```


# Inspecting the Results
Of course, we need to inspect the analysis results. The simplest method is `summary`. Based on the different analyses executed, `summary` will provide estimates, test statistics and other useful information as a data frame. There are many options for displaying different output, check the vignette on regression and hypothesis tests. 
```{r summary}
summary(mv)
```
# Visualizing the Results
For multiverse analysis, specification curve is one of the suggested visualizations for multiverse analysis. You can use `spec_curve` to visualize the variable estimates in each universe. There are many options for creating specification curves with different orderings and variables, check the vignette on specification curves. 
```{r spec_curve.glm_mverse}
# display the specification curve by default setting
spec_curve(mv, var = "damage")
```
